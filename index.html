<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PraiasSP Tools - An√°lise de Documentos</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <img
          src="/static/logo-verde.png"
          alt="Logo PraiasSP"
          class="logo-header-tools"
        />
        <h1>Processamento mensal das presta√ß√µes de contas Praias-SP</h1>
      </div>

      <div class="chat-container" id="chatContainer">
        <!-- Mensagem inicial ser√° adicionada dinamicamente -->
      </div>

      <div class="input-container">
        <div class="input-wrapper">
          <label
            for="fileInput"
            class="file-input-label"
            title="Anexar arquivo"
          >
            üìé
          </label>
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept=".pdf,.xlsx,.xls"
            multiple
          />
          <textarea
            id="messageInput"
            class="message-input"
            placeholder="Digite sua mensagem ou envie um documento..."
            rows="1"
          ></textarea>
          <button id="sendButton" class="send-button">
            <span id="sendIcon" class="send-icon">‚û§</span>
          </button>
          <button id="exportExcel" class="export-button">Exportar Excel</button>
          <button id="exportPDF" class="export-button">Exportar PDF</button>
          <button id="consultarHistorico" class="export-button">
            üìö Base Hist√≥rica
          </button>
        </div>
        <div id="filePreview" class="file-preview">
          <div class="file-info">
            <span id="fileName"></span>
            <button id="removeFile" class="remove-file">‚úï</button>
          </div>
          <div id="processingStatus" class="processing-status"></div>
        </div>
      </div>
    </div>

    <button class="config-toggle" onclick="toggleConfig()">‚öôÔ∏è</button>
    <div id="configPanel" class="config-panel">
      <h3>Configura√ß√µes</h3>
      <div class="config-group">
        <label for="model">Modelo:</label>
        <input type="text" id="model" value="gpt-4o" placeholder="gpt-4o" />
      </div>
      <div class="config-group">
        <label for="maxTokens">Max Tokens:</label>
        <input type="number" id="maxTokens" value="4000" placeholder="4000" />
      </div>
      <div class="config-group">
        <span class="protected-key"
          >üîí Chave de API protegida no servidor!</span
        >
      </div>
    </div>
    <script>
      function toggleConfig() {
        const panel = document.getElementById("configPanel");
        panel.classList.toggle("open");
      }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      // Sistema de Base Hist√≥rica
      let baseHistorica = [];
      let localStorageAvailable = false;

      function checkLocalStorageAvailability() {
        try {
          const test = "__storage_test__";
          localStorage.setItem(test, test);
          localStorage.removeItem(test);
          localStorageAvailable = true;
          console.log("‚úÖ localStorage dispon√≠vel");
          return true;
        } catch (e) {
          console.warn("‚ö†Ô∏è localStorage bloqueado, usando mem√≥ria");
          localStorageAvailable = false;
          return false;
        }
      }

      function safeLocalStorageSetItem(key, value) {
        if (localStorageAvailable) {
          try {
            localStorage.setItem(key, value);
          } catch (e) {
            console.warn(`‚ö†Ô∏è Erro ao salvar em localStorage: ${e.message}`);
          }
        }
      }

      function safeLocalStorageGetItem(key) {
        if (localStorageAvailable) {
          try {
            return localStorage.getItem(key);
          } catch (e) {
            console.warn(`‚ö†Ô∏è Erro ao carregar de localStorage: ${e.message}`);
            return null;
          }
        }
        return null;
      }

      async function salvarNaBaseHistorica(analise) {
        const registro = {
          id: Date.now(),
          data: new Date().toLocaleDateString("pt-BR"),
          hora: new Date().toLocaleTimeString("pt-BR"),
          arquivos: currentFiles.map((f) => f.name),
          analise: analise,
        };

        baseHistorica.push(registro);

        if (baseHistorica.length > 50) {
          baseHistorica = baseHistorica.slice(-50);
        }

        safeLocalStorageSetItem(
          "toolsBaseHistorica",
          JSON.stringify(baseHistorica)
        );
        console.log("‚úÖ An√°lise salva na base hist√≥rica:", registro.id);
      }

      function carregarBaseHistorica() {
        const dados = safeLocalStorageGetItem("toolsBaseHistorica");
        if (dados) {
          try {
            baseHistorica = JSON.parse(dados);
            console.log(
              `üìö Base hist√≥rica carregada: ${baseHistorica.length} registros`
            );
          } catch (e) {
            console.warn("‚ö†Ô∏è Erro ao parsear base hist√≥rica:", e.message);
          }
        }
      }

      async function consultarBaseHistorica() {
        if (baseHistorica.length === 0) {
          addMessage(
            "assistant",
            "üìö <strong>Base Hist√≥rica Vazia</strong><br>Ainda n√£o h√° an√°lises registradas."
          );
          return;
        }

        const resumo = `üìö <strong>CONSULTA √Ä BASE HIST√ìRICA - PRAIASSP TOOLS</strong><br><br>
        <strong>üìä Estat√≠sticas Gerais:</strong><br>
        ‚Ä¢ Total de an√°lises: <strong>${baseHistorica.length}</strong><br>
        ‚Ä¢ Per√≠odo: ${baseHistorica[0]?.data} at√© ${
          baseHistorica[baseHistorica.length - 1]?.data
        }<br>
        ‚Ä¢ √öltima an√°lise: ${
          baseHistorica[baseHistorica.length - 1]?.data
        }<br><br>
        <strong>üè¢ An√°lises Recentes:</strong><br>
        ${baseHistorica
          .slice(-5)
          .reverse()
          .map(
            (reg) =>
              `‚Ä¢ <strong>${reg.data}</strong> - ${reg.arquivos.join(", ")}`
          )
          .join("<br>")}`;

        addMessage("assistant", resumo);
      }

      document.getElementById("consultarHistorico").onclick =
        consultarBaseHistorica;

      document.addEventListener("DOMContentLoaded", function () {
        checkLocalStorageAvailability();
        carregarBaseHistorica();

        setTimeout(() => {
          const welcomeMessage = `üéØ <strong>BEM-VINDO AO SISTEMA DE AN√ÅLISE DE DOCUMENTOS - PRAIASSP TOOLS</strong><br><br>

üëã Ol√°! Estou pronto para analisar seus documentos PDF e planilhas Excel e gerar an√°lises comparativas.<br><br>

‚ú® <strong>O que posso fazer:</strong><br>
‚Ä¢ Extrair informa√ß√µes de PDFs e arquivos Excel<br>
‚Ä¢ Comparar dados entre m√∫ltiplos documentos<br>
‚Ä¢ Gerar an√°lises detalhadas com IA<br>
‚Ä¢ Exportar resultados em Excel ou PDF<br>
‚Ä¢ Manter hist√≥rico de an√°lises<br><br>

üëá <strong>Como come√ßar:</strong><br>
<strong style='color: #e74c3c; font-size: 16px'>üëâ Anexe documentos PDF ou planilhas Excel para come√ßar a an√°lise.</strong><br><br>
<table border='1' style='border-collapse:collapse;font-size:13px;margin:10px 0;width:100%'>
<tr style='background:#0e938f;color:white'><th>Clique em üìé</th><th>Selecione os arquivos</th><th>Envie sua mensagem</th></tr>
<tr style='background:#f8f9fa'><td style='text-align:center'>Anexar</td><td>Seus PDFs/XLS com dados</td><td>Depois digite "Analisar" ou s√≥ pressione ‚û§</td></tr>
</table><br>

<strong>Status:</strong><br>
‚Ä¢ Banco de hist√≥rico: <strong>${baseHistorica.length} an√°lises</strong><br>
‚Ä¢ Sistema: <strong>‚úÖ Operacional</strong><br><br>

‚è±Ô∏è Comece anexando seus documentos!`;

          addMessage("assistant", welcomeMessage);
        }, 500);
      });

      const scriptXLSX = document.createElement("script");
      scriptXLSX.src =
        "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
      document.head.appendChild(scriptXLSX);

      let currentFiles = [];
      let fileContents = [];
      let conversationHistory = [];

      if (typeof pdfjsLib !== "undefined") {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
      }

      document
        .getElementById("fileInput")
        .addEventListener("change", handleFileSelect);
      document
        .getElementById("removeFile")
        .addEventListener("click", removeFile);
      document
        .getElementById("sendButton")
        .addEventListener("click", sendMessage);
      document
        .getElementById("messageInput")
        .addEventListener("keydown", handleKeyDown);
      document
        .getElementById("messageInput")
        .addEventListener("input", adjustTextareaHeight);

      loadSettings();

      async function loadSettings() {
        try {
          const model = safeLocalStorageGetItem("openai_model") || "gpt-4o";
          const maxTokens =
            Number(safeLocalStorageGetItem("max_tokens")) || 4000;

          document.getElementById("model").value = model;
          document.getElementById("maxTokens").value = maxTokens;
          console.log("üíæ Configura√ß√µes carregadas");
        } catch (error) {
          console.warn("‚ö†Ô∏è Erro ao carregar configura√ß√µes:", error);
        }
      }

      function saveSettings() {
        const model = document.getElementById("model").value;
        const maxTokens = document.getElementById("maxTokens").value;

        safeLocalStorageSetItem("openai_model", model);
        safeLocalStorageSetItem("max_tokens", String(parseInt(maxTokens)));
      }

      function toggleConfig() {
        const panel = document.getElementById("configPanel");
        panel.classList.toggle("open");
        saveSettings();
      }

      function adjustTextareaHeight() {
        const textarea = document.getElementById("messageInput");
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      }

      function handleKeyDown(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      }

      function extractEssentialContent(text) {
        let essentialContent = text;
        essentialContent = essentialContent.replace(/\n{3,}/g, "\n\n");

        if (essentialContent.length > 8000) {
          essentialContent = essentialContent.substring(0, 8000);
          essentialContent += "\n\n[... conte√∫do editado para espa√ßo]";
        }

        return essentialContent;
      }

      async function extractPDFText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = async function (e) {
            try {
              const typedArray = new Uint8Array(e.target.result);
              const pdf = await pdfjsLib.getDocument(typedArray).promise;
              let fullText = "";
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items
                  .map((item) => item.str)
                  .join(" ");
                fullText += `\n\n--- P√°gina ${i} ---\n${pageText}`;
              }
              resolve(fullText.trim());
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error("Erro ao ler arquivo PDF"));
          reader.readAsArrayBuffer(file);
        });
      }

      async function extractExcelData(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              let allData = "";
              workbook.SheetNames.forEach((sheetName) => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  header: 1,
                });
                allData += `\n\n--- Planilha: ${sheetName} ---\n`;
                jsonData.forEach((row, index) => {
                  if (row.length > 0) {
                    allData += `Linha ${index + 1}: ${row.join(" | ")}\n`;
                  }
                });
              });
              resolve(allData.trim());
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = () => reject(new Error("Erro ao ler arquivo Excel"));
          reader.readAsArrayBuffer(file);
        });
      }

      function removeFile() {
        currentFiles = [];
        fileContents = [];

        const fileInput = document.getElementById("fileInput");
        if (fileInput) fileInput.value = "";

        const preview = document.getElementById("filePreview");
        if (preview) {
          preview.classList.remove("show");
          preview.style.display = "none";
        }

        const fileName = document.getElementById("fileName");
        if (fileName) fileName.textContent = "";
      }

      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input ? input.value.trim() : "";

        if (!message && (!fileContents || fileContents.length === 0)) return;

        if (message) {
          addMessage("user", message);
          conversationHistory.push({ role: "user", content: message });
        }

        if (input) {
          input.value = "";
          adjustTextareaHeight();
        }

        const loadingId = addMessage("assistant", "");
        showLoading(loadingId);

        try {
          let response = "";

          if (fileContents && fileContents.length > 0) {
            updateLoadingMessage(
              loadingId,
              `Analisando ${fileContents.length} arquivo(s)...`
            );

            let consolidatedMessage = `AN√ÅLISE DE DOCUMENTOS\n\n`;

            fileContents.forEach((file, fileIndex) => {
              const essentialContent = extractEssentialContent(file.content);
              consolidatedMessage += `\n${"‚ïê".repeat(50)}\nDOCUMENTO ${
                fileIndex + 1
              }: ${file.name}\n${"‚ïê".repeat(50)}\n`;
              consolidatedMessage += essentialContent;
            });

            const response_text = await callBackend(
              "Voc√™ √© um assistente especializado em an√°lise de documentos. Analise os documentos fornecidos e extraia informa√ß√µes importantes.",
              consolidatedMessage
            );

            response = response_text;

            if (message) {
              updateLoadingMessage(loadingId, "Processando sua pergunta...");
              const messageResponse = await callBackend(
                "Voc√™ √© um assistente especializado em an√°lise de documentos.",
                `Com base na an√°lise dos documentos, responda: ${message}`
              );
              response += `\n\n=== RESPOSTA √Ä SUA PERGUNTA ===\n${messageResponse}`;
            }
          } else if (message) {
            response = await callBackend(
              `Voc√™ √© um assistente especializado em an√°lise de documentos do PraiasSP Tools. Responda em portugu√™s.`,
              message
            );
          }

          updateMessage(loadingId, response);
          conversationHistory.push({ role: "assistant", content: response });

          salvarNaBaseHistorica(response);
        } catch (error) {
          updateMessage(loadingId, `Erro: ${error.message}`);
        }
      }

      document.getElementById("exportExcel").onclick = function () {
        const chatContainer = document.getElementById("chatContainer");
        const wb = XLSX.utils.book_new();

        const messages = chatContainer.querySelectorAll(".message.assistant");
        if (messages.length > 0) {
          const ultimaMensagem = messages[messages.length - 1];
          const conteudoDiv = ultimaMensagem.querySelector(".message-content");
          const tables = conteudoDiv.querySelectorAll("table");

          if (tables.length > 0) {
            tables.forEach((table, index) => {
              const ws = XLSX.utils.table_to_sheet(table);
              XLSX.utils.book_append_sheet(wb, ws, `An√°lise_${index + 1}`);
            });
          } else {
            const texto = conteudoDiv.innerText;
            const linhas = texto.split("\n").map((linha) => [linha]);
            const ws = XLSX.utils.aoa_to_sheet([
              ["PRAIASSP TOOLS - AN√ÅLISE"],
              [`Data: ${new Date().toLocaleDateString("pt-BR")}`],
              [""],
              ...linhas,
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio");
          }
        }

        const filename = `analise_${new Date()
          .toISOString()
          .slice(0, 10)}.xlsx`;
        XLSX.writeFile(wb, filename);
      };

      document.getElementById("exportPDF").onclick = function () {
        const chatContainer = document.getElementById("chatContainer");
        const jsPDF = window.jspdf ? window.jspdf.jsPDF : window.jsPDF;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("PRAIASSP TOOLS - An√°lise de Documentos", 10, 20);
        doc.setFontSize(10);
        doc.text(`Data: ${new Date().toLocaleDateString("pt-BR")}`, 10, 30);

        const messages = chatContainer.querySelectorAll(".message.assistant");
        let conteudo = "";
        if (messages.length > 0) {
          const ultimaMensagem = messages[messages.length - 1];
          const conteudoDiv = ultimaMensagem.querySelector(".message-content");
          conteudo = conteudoDiv.innerText;
        } else {
          conteudo = chatContainer.innerText;
        }

        conteudo = conteudo.replace(/[\u{1F300}-\u{1F9FF}]/gu, "");

        const paragrafs = conteudo.split("\n");
        doc.setFontSize(11);
        let yPosition = 40;

        paragrafs.forEach((paragrafo) => {
          if (paragrafo.trim() === "") {
            yPosition += 3;
          } else {
            const linhas = doc.splitTextToSize(paragrafo, 190);
            linhas.forEach((linha) => {
              if (yPosition > 280) {
                doc.addPage();
                yPosition = 20;
              }
              doc.text(linha, 10, yPosition);
              yPosition += 5;
            });
          }
        });

        const filename = `analise_${new Date().toISOString().slice(0, 10)}.pdf`;
        doc.save(filename);
      };

      async function callBackend(systemPrompt, userMessage) {
        console.log("üîó Iniciando chamada ao backend...");

        const model = document.getElementById("model").value || "gpt-4o";
        const maxTokens =
          parseInt(document.getElementById("maxTokens").value) || 4000;

        const messages = [
          { role: "system", content: systemPrompt },
          { role: "user", content: userMessage },
        ];

        // Use a URL do seu backend Render
        const backendUrl = window.location.origin + "/api/analyze-pdf";

        try {
          const response = await fetch(backendUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              max_tokens: maxTokens,
            }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || "Erro na API do backend");
          }

          const data = await response.json();
          return (
            data.choices[0].message.content || data.analysis || data.message
          );
        } catch (error) {
          console.error("‚ùå Erro ao chamar backend:", error);
          throw error;
        }
      }

      function addMessage(sender, content) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;
        const messageId = "msg_" + Date.now();
        messageDiv.id = messageId;
        messageDiv.innerHTML = `
          <div class="avatar ${sender}">
            ${
              sender === "user"
                ? "<img src='static/tools-avatar-sem-fundo.png' alt='Logo Tools' class='logo-tools-avatar'/>"
                : "<span class='robot-emoji'>ü§ñ</span>"
            }
          </div>
          <div class="message-content">${content}</div>
        `;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return messageId;
      }

      function showLoading(messageId) {
        const messageDiv = document.getElementById(messageId);
        const contentDiv = messageDiv.querySelector(".message-content");
        contentDiv.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            Analisando...
          </div>
        `;
      }

      function updateLoadingMessage(messageId, text) {
        const messageDiv = document.getElementById(messageId);
        const contentDiv = messageDiv.querySelector(".message-content");
        contentDiv.innerHTML = `
          <div class="loading">
            <div class="spinner"></div>
            ${text}
          </div>
        `;
      }

      function updateMessage(messageId, content) {
        const messageDiv = document.getElementById(messageId);
        const contentDiv = messageDiv.querySelector(".message-content");
        const cleanedContent = content.replace(/\n{3,}/g, "\n\n");
        contentDiv.innerHTML = cleanedContent.replace(/\n/g, "<br>");
      }

      ["model", "maxTokens"].forEach((id) => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.addEventListener("input", saveSettings);
        }
      });

      async function handleFileSelect(e) {
        const preview = document.getElementById("filePreview");
        const files = Array.from(e.target.files);
        const fileNames = currentFiles.map((f) => f.name);
        files.forEach((f) => {
          if (!fileNames.includes(f.name)) {
            currentFiles.push(f);
          }
        });

        if (currentFiles.length === 0) {
          document.getElementById("fileName").textContent = "";
          preview.classList.remove("show");
          preview.style.display = "none";
          return;
        }

        document.getElementById("fileName").textContent = currentFiles
          .map((f) => f.name)
          .join(", ");
        preview.classList.add("show");
        preview.style.display = "block";
        document.getElementById("fileInput").value = "";

        Promise.all(
          files.map(async (file) => {
            let content = "";
            try {
              if (file.name.toLowerCase().endsWith(".pdf")) {
                content = await extractPDFText(file);
              } else if (
                file.name.toLowerCase().endsWith(".xlsx") ||
                file.name.toLowerCase().endsWith(".xls")
              ) {
                content = await extractExcelData(file);
              }
              const processedNames = fileContents.map((f) => f.name);
              if (!processedNames.includes(file.name)) {
                fileContents.push({ name: file.name, content: content });
              }
            } catch (error) {
              console.error(`Erro ao processar ${file.name}:`, error.message);
            }
          })
        ).then(() => {
          updateFilePreview();
          if (fileContents.length >= 2) {
            addMessage(
              "assistant",
              "üöÄ <strong>An√°lise Autom√°tica Iniciada</strong><br>üìä M√∫ltiplos documentos detectados."
            );
            sendMessage();
          } else if (fileContents.length === 1) {
            addMessage(
              "assistant",
              "üìÑ <strong>Arquivo anexado.</strong> Para an√°lise comparativa, anexe mais documentos ou digite uma pergunta."
            );
          }
        });
      }

      function updateFilePreview() {
        const preview = document.getElementById("filePreview");
        const fileName = document.getElementById("fileName");
        const processingStatus = document.getElementById("processingStatus");

        if (fileContents.length > 0) {
          fileName.textContent = fileContents
            .map((file) => file.name)
            .join(", ");
          processingStatus.textContent = `${fileContents.length} arquivo(s) adicionado(s)`;
          preview.classList.add("show");
          preview.style.display = "block";
        } else {
          preview.classList.remove("show");
          preview.style.display = "none";
        }
      }
    </script>
  </body>
</html>
